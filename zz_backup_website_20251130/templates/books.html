{% extends "base.html" %}

{% block title %}Assets - Clubinho Bookstore{% endblock %}
{% block header_title %}Assets{% endblock %}
{% block header_subtitle %}Manage book inventory{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/page-enhancements.css') }}">
{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Page Header -->
    <div class="page-header">
        <h2 class="page-title">
            <i class="fas fa-book me-2" aria-hidden="true"></i>
            Asset Management
        </h2>
        <button type="button"
                class="btn-add"
                data-bs-toggle="modal"
                data-bs-target="#addBookModal"
                aria-label="Add new asset">
            <i class="fas fa-plus me-1" aria-hidden="true"></i>
            Add Asset
        </button>
    </div>

    <!-- Search Section - Using action-section like Orders and Customers pages -->
    <div class="action-section">
        <div class="row g-2">
            <div class="col-12">
                <label for="searchInput" class="sr-only">Search assets by name</label>
                <input type="text"
                       id="searchInput"
                       class="form-control search-input"
                       placeholder="Search assets by name..."
                       aria-label="Search assets by name">
            </div>
        </div>
    </div>

    <!-- Books List - Table Style -->
    <div id="booksList" class="books-table-container">
        {% if books %}
            <div class="table-responsive">
                <table class="books-table">
                    <thead>
                        <tr>
                            <th>Asset Name</th>
                            <th>R$ Price</th>
                            <th>¥ Price</th>
                            <th>Times Sold</th>
                            <th>Total Revenue</th>
                            <th>Added</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for book in books %}
                        <tr class="book-item" data-search="{{ book.asset_name|lower }}">
                            <td class="cell-name">
                                <span class="asset-name">{{ book.asset_name }}</span>
                                {% if book.times_sold and book.times_sold > 10 %}
                                    <span class="stock-badge stock-bestseller">
                                        <i class="fas fa-fire"></i> Best Seller
                                    </span>
                                {% elif book.ienes and book.ienes > 0 %}
                                    <span class="stock-badge stock-in-stock">
                                        <i class="fas fa-check-circle"></i> In Stock
                                    </span>
                                {% endif %}
                            </td>
                            <td class="cell-price">R$ {{ "{:.2f}".format(book.real) }}</td>
                            <td class="cell-price">¥ {{ book.ienes }}</td>
                            <td class="cell-center">{{ book.times_sold }}</td>
                            <td class="cell-revenue">¥ {{ "{:,.0f}".format(book.total_revenue) }}</td>
                            <td class="cell-date">{{ book.created_at.strftime('%m/%d/%Y') if book.created_at else 'N/A' }}</td>
                            <td class="cell-actions">
                                <button type="button"
                                        class="btn-action btn-edit"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editBookModal"
                                        data-code="{{ book.asset_code }}"
                                        data-name="{{ book.asset_name }}"
                                        data-real="{{ book.real }}"
                                        data-ienes="{{ book.ienes }}"
                                        data-black="{{ book.black }}"
                                        data-private="{{ book.private }}"
                                        aria-label="Edit {{ book.asset_name }}"
                                        title="Edit">
                                    <i class="fas fa-edit" aria-hidden="true"></i>
                                </button>
                                <button type="button"
                                        class="btn-action btn-delete"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteBookModal"
                                        data-code="{{ book.asset_code }}"
                                        data-name="{{ book.asset_name }}"
                                        aria-label="Delete {{ book.asset_name }}"
                                        title="Delete">
                                    <i class="fas fa-trash" aria-hidden="true"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-book"></i>
                <h3>No Assets Found</h3>
                <p>Start by adding your first book or asset</p>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBookModal">
                    <i class="fas fa-plus me-1"></i>
                    Add First Asset
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- Add Book Modal -->
<div class="modal fade" id="addBookModal" tabindex="-1" aria-labelledby="addBookModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addBookModalLabel">Add New Asset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close dialog"></button>
            </div>
            <form method="POST">
                <input type="hidden" name="action" value="add">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="asset_name" class="form-label">Asset Name *</label>
                        <input type="text" class="form-control" name="asset_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="real" class="form-label">Real Price (BRL)</label>
                        <input type="number" step="0.01" class="form-control" name="real" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="ienes" class="form-label">Yen Price (JPY)</label>
                        <input type="number" class="form-control" name="ienes" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="black" class="form-label">Black Market Price</label>
                        <input type="number" class="form-control" name="black" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="private" class="form-label">Private Price</label>
                        <input type="number" class="form-control" name="private" value="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Asset</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Book Modal -->
<div class="modal fade" id="editBookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Asset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <input type="hidden" name="action" value="edit">
                <input type="hidden" name="asset_code" id="edit_asset_code">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_asset_name" class="form-label">Asset Name *</label>
                        <input type="text" class="form-control" name="asset_name" id="edit_asset_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_real" class="form-label">Real Price (BRL)</label>
                        <input type="number" step="0.01" class="form-control" name="real" id="edit_real">
                    </div>
                    <div class="mb-3">
                        <label for="edit_ienes" class="form-label">Yen Price (JPY)</label>
                        <input type="number" class="form-control" name="ienes" id="edit_ienes">
                    </div>
                    <div class="mb-3">
                        <label for="edit_black" class="form-label">Black Market Price</label>
                        <input type="number" class="form-control" name="black" id="edit_black">
                    </div>
                    <div class="mb-3">
                        <label for="edit_private" class="form-label">Private Price</label>
                        <input type="number" class="form-control" name="private" id="edit_private">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Asset</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Book Modal -->
<div class="modal fade" id="deleteBookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Asset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="asset_code" id="delete_asset_code">
                <div class="modal-body">
                    <p>Are you sure you want to delete asset <strong id="delete_asset_name"></strong>?</p>
                    <p class="text-muted">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete Asset</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const books = document.querySelectorAll('.book-item');

    books.forEach(book => {
        const searchData = book.getAttribute('data-search');
        if (searchData.includes(searchTerm)) {
            book.style.display = 'table-row';
        } else {
            book.style.display = 'none';
        }
    });
});

// Modal functionality
document.addEventListener('DOMContentLoaded', function() {
    // Edit book modal
    const editModal = document.getElementById('editBookModal');
    if (editModal) {
        editModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            document.getElementById('edit_asset_code').value = button.getAttribute('data-code');
            document.getElementById('edit_asset_name').value = button.getAttribute('data-name');
            document.getElementById('edit_real').value = button.getAttribute('data-real');
            document.getElementById('edit_ienes').value = button.getAttribute('data-ienes');
            document.getElementById('edit_black').value = button.getAttribute('data-black');
            document.getElementById('edit_private').value = button.getAttribute('data-private');
        });
    }
    
    // Delete book modal
    const deleteModal = document.getElementById('deleteBookModal');
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            document.getElementById('delete_asset_code').value = button.getAttribute('data-code');
            document.getElementById('delete_asset_name').textContent = button.getAttribute('data-name');
        });
    }
});
</script>
{% endblock %}