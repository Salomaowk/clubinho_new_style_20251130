{% extends "base.html" %}

{% block title %}Assets - Clubinho Bookstore{% endblock %}
{% block header_title %}Assets{% endblock %}
{% block header_subtitle %}Manage book inventory{% endblock %}

{% block content %}
<div class="px-6">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-6 py-4">
        <h2 class="text-2xl font-bold text-gray-100 flex items-center">
            <i class="fas fa-book mr-3" aria-hidden="true"></i>Asset Management
        </h2>
        <button type="button"
                class="btn-primary"
                data-bs-toggle="modal"
                data-bs-target="#addBookModal"
                aria-label="Add new asset">
            <i class="fas fa-plus mr-2" aria-hidden="true"></i>Add Asset
        </button>
    </div>

    <!-- Search Section -->
    <div class="mb-6">
        <div class="grid grid-cols-1 gap-3">
            <div>
                <label for="searchInput" class="sr-only">Search assets by name</label>
                <input type="text"
                       id="searchInput"
                       class="form-input w-full"
                       placeholder="Search assets by name..."
                       aria-label="Search assets by name">
            </div>
        </div>
    </div>

    <!-- Books List - Table Style -->
    <div id="booksList" class="mb-6">
        {% if books %}
            <div class="overflow-x-auto rounded-lg">
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-800/50 border-b border-gray-700">
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Asset Name</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">R$ Price</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">¥ Price</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-300 uppercase tracking-wider">Times Sold</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Total Revenue</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Added</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-300 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700/50">
                        {% for book in books %}
                        <tr class="book-item bg-gray-800/30 hover:bg-gray-700/50 transition-colors duration-200" data-search="{{ book.asset_name|lower }}">
                            <td class="px-4 py-4">
                                <div class="flex flex-col">
                                    <span class="text-gray-100 font-medium">{{ book.asset_name }}</span>
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        {% if book.times_sold and book.times_sold > 10 %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-500/20 text-red-400 border border-red-500/30">
                                                <i class="fas fa-fire mr-1"></i> Best Seller
                                            </span>
                                        {% elif book.ienes and book.ienes > 0 %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-500/20 text-green-400 border border-green-500/30">
                                                <i class="fas fa-check-circle mr-1"></i> In Stock
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-4 text-gray-300 font-mono">R$ {{ "{:.2f}".format(book.real) }}</td>
                            <td class="px-4 py-4 text-gray-300 font-mono">¥ {{ book.ienes }}</td>
                            <td class="px-4 py-4 text-center text-gray-300">{{ book.times_sold }}</td>
                            <td class="px-4 py-4 text-gray-100 font-semibold font-mono">¥ {{ "{:,.0f}".format(book.total_revenue) }}</td>
                            <td class="px-4 py-4 text-gray-400 text-sm">{{ book.created_at.strftime('%m/%d/%Y') if book.created_at else 'N/A' }}</td>
                            <td class="px-4 py-4">
                                <div class="flex items-center justify-center space-x-2">
                                    <button type="button"
                                            class="btn-action btn-primary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#editBookModal"
                                            data-code="{{ book.asset_code }}"
                                            data-name="{{ book.asset_name }}"
                                            data-real="{{ book.real }}"
                                            data-ienes="{{ book.ienes }}"
                                            data-black="{{ book.black }}"
                                            data-private="{{ book.private }}"
                                            aria-label="Edit {{ book.asset_name }}"
                                            title="Edit">
                                        <i class="fas fa-edit" aria-hidden="true"></i>
                                    </button>
                                    <button type="button"
                                            class="btn-action btn-danger"
                                            data-bs-toggle="modal"
                                            data-bs-target="#deleteBookModal"
                                            data-code="{{ book.asset_code }}"
                                            data-name="{{ book.asset_name }}"
                                            aria-label="Delete {{ book.asset_name }}"
                                            title="Delete">
                                        <i class="fas fa-trash" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-book text-6xl mb-4 text-gray-600"></i>
                <h3 class="text-xl font-semibold text-gray-300 mb-2">No Assets Found</h3>
                <p class="text-gray-400 mb-4">Start by adding your first book or asset</p>
                <button type="button" class="btn-primary" data-bs-toggle="modal" data-bs-target="#addBookModal">
                    <i class="fas fa-plus mr-2"></i>Add First Asset
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- Add Book Modal -->
<div class="modal fade" id="addBookModal" tabindex="-1" aria-labelledby="addBookModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addBookModalLabel">
                    <i class="fas fa-book mr-2"></i>Add New Asset
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close dialog"></button>
            </div>
            <form method="POST">
                <input type="hidden" name="action" value="add">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="asset_name" class="form-label">Asset Name *</label>
                        <input type="text" class="form-input" name="asset_name" required>
                    </div>
                    <div class="form-group">
                        <label for="real" class="form-label">Real Price (BRL)</label>
                        <input type="number" step="0.01" class="form-input" name="real" value="0">
                    </div>
                    <div class="form-group">
                        <label for="ienes" class="form-label">Yen Price (JPY)</label>
                        <input type="number" class="form-input" name="ienes" value="0">
                    </div>
                    <div class="form-group">
                        <label for="black" class="form-label">Black Market Price</label>
                        <input type="number" class="form-input" name="black" value="0">
                    </div>
                    <div class="form-group">
                        <label for="private" class="form-label">Private Price</label>
                        <input type="number" class="form-input" name="private" value="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn-primary">Add Asset</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Book Modal -->
<div class="modal fade" id="editBookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit mr-2"></i>Edit Asset
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <input type="hidden" name="action" value="edit">
                <input type="hidden" name="asset_code" id="edit_asset_code">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="edit_asset_name" class="form-label">Asset Name *</label>
                        <input type="text" class="form-input" name="asset_name" id="edit_asset_name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_real" class="form-label">Real Price (BRL)</label>
                        <input type="number" step="0.01" class="form-input" name="real" id="edit_real">
                    </div>
                    <div class="form-group">
                        <label for="edit_ienes" class="form-label">Yen Price (JPY)</label>
                        <input type="number" class="form-input" name="ienes" id="edit_ienes">
                    </div>
                    <div class="form-group">
                        <label for="edit_black" class="form-label">Black Market Price</label>
                        <input type="number" class="form-input" name="black" id="edit_black">
                    </div>
                    <div class="form-group">
                        <label for="edit_private" class="form-label">Private Price</label>
                        <input type="number" class="form-input" name="private" id="edit_private">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn-primary">Update Asset</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Book Modal -->
<div class="modal fade" id="deleteBookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header-danger">
                <h5 class="modal-title">
                    <i class="fas fa-trash mr-2"></i>Delete Asset
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="asset_code" id="delete_asset_code">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>Warning!</strong> This action cannot be undone.
                    </div>
                    <p class="text-gray-300">Are you sure you want to delete asset <strong id="delete_asset_name"></strong>?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn-danger">Delete Asset</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const books = document.querySelectorAll('.book-item');

    books.forEach(book => {
        const searchData = book.getAttribute('data-search');
        if (searchData.includes(searchTerm)) {
            book.style.display = 'table-row';
        } else {
            book.style.display = 'none';
        }
    });
});

// Modal functionality
document.addEventListener('DOMContentLoaded', function() {
    // Edit book modal
    const editModal = document.getElementById('editBookModal');
    if (editModal) {
        editModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            document.getElementById('edit_asset_code').value = button.getAttribute('data-code');
            document.getElementById('edit_asset_name').value = button.getAttribute('data-name');
            document.getElementById('edit_real').value = button.getAttribute('data-real');
            document.getElementById('edit_ienes').value = button.getAttribute('data-ienes');
            document.getElementById('edit_black').value = button.getAttribute('data-black');
            document.getElementById('edit_private').value = button.getAttribute('data-private');
        });
    }

    // Delete book modal
    const deleteModal = document.getElementById('deleteBookModal');
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            document.getElementById('delete_asset_code').value = button.getAttribute('data-code');
            document.getElementById('delete_asset_name').textContent = button.getAttribute('data-name');
        });
    }
});
</script>
{% endblock %}
