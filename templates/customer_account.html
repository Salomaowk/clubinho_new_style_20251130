{% extends "base.html" %}

{% block title %}{{ customer.customer_name }} - Account - Clubinho Bookstore{% endblock %}

{% block header_title %}Customer Account{% endblock %}
{% block header_subtitle %}{{ customer.customer_name }} - Financial Management{% endblock %}

{% block content %}
<!-- Customer Info Header -->
<div class="px-6 py-4 mb-6">
    <div class="card">
        <div class="flex flex-wrap justify-between items-start gap-4">
            <div class="flex-1 min-w-0">
                <h2 class="text-2xl font-bold text-gray-100 mb-2 flex items-center">
                    <i class="fas fa-user-circle mr-3"></i>{{ customer.customer_name }}
                </h2>
                <div class="text-sm text-gray-400 space-y-1">
                    {% if customer.customer_address %}
                        <div class="flex items-center"><i class="fas fa-map-marker-alt w-4 mr-2"></i>{{ customer.customer_address }}</div>
                    {% endif %}
                    {% if customer.customer_telephone %}
                        <div class="flex items-center"><i class="fas fa-phone w-4 mr-2"></i>{{ customer.customer_telephone }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="flex flex-wrap gap-3">
                <a href="{{ url_for('customers') }}" class="btn-secondary">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Customers
                </a>
                <a href="{{ url_for('customer_orders', customer_name=customer.customer_name) }}" class="btn-primary">
                    <i class="fas fa-shopping-cart mr-2"></i>View Orders
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Account Summary -->
<div class="px-6 mb-6">
    <h3 class="text-xl font-bold text-gray-100 mb-4 flex items-center">
        <i class="fas fa-chart-pie mr-3"></i>Account Summary
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="stat-card border-t-2 border-blue-500">
            <div class="flex items-center space-x-4">
                <div class="w-14 h-14 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-shopping-cart text-white text-xl"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-2xl font-bold text-gray-100">¥{{ "{:,.0f}".format(account_summary.total_debt) }}</div>
                    <div class="text-xs text-gray-400 uppercase tracking-wide">Total Spent</div>
                </div>
            </div>
        </div>

        <div class="stat-card border-t-2 border-green-500">
            <div class="flex items-center space-x-4">
                <div class="w-14 h-14 rounded-full bg-gradient-to-br from-green-500 to-green-700 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-yen-sign text-white text-xl"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-2xl font-bold text-gray-100">¥{{ "{:,.0f}".format(account_summary.total_payments) }}</div>
                    <div class="text-xs text-gray-400 uppercase tracking-wide">Total Payments</div>
                </div>
            </div>
        </div>

        <div class="stat-card border-t-2 border-cyan-500">
            <div class="flex items-center space-x-4">
                <div class="w-14 h-14 rounded-full bg-gradient-to-br from-cyan-500 to-cyan-700 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-plus-circle text-white text-xl"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-2xl font-bold text-gray-100">¥{{ "{:,.0f}".format(account_summary.total_credits) }}</div>
                    <div class="text-xs text-gray-400 uppercase tracking-wide">Credits</div>
                </div>
            </div>
        </div>

        <div class="stat-card border-t-2 {% if account_summary.current_balance > 0 %}border-red-500{% else %}border-green-500{% endif %}">
            <div class="flex items-center space-x-4">
                <div class="w-14 h-14 rounded-full bg-gradient-to-br {% if account_summary.current_balance > 0 %}from-red-500 to-red-700{% else %}from-green-500 to-green-700{% endif %} flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-clock text-white text-xl"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-2xl font-bold text-gray-100">¥{{ "{:,.0f}".format(account_summary.current_balance) }}</div>
                    <div class="text-xs text-gray-400 uppercase tracking-wide">
                        {% if account_summary.current_balance > 0 %}
                            Pending Payment
                        {% elif account_summary.current_balance < 0 %}
                            Credit Balance
                        {% else %}
                            Balanced
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="px-6 mb-6">
    <h3 class="text-xl font-bold text-gray-100 mb-4 flex items-center">
        <i class="fas fa-bolt mr-3"></i>Quick Actions
    </h3>
    <div class="flex flex-wrap gap-3">
        <button class="btn-primary" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
            <i class="fas fa-credit-card mr-2"></i>Add Payment
        </button>
        <button class="btn-danger" data-bs-toggle="modal" data-bs-target="#addDebitModal">
            <i class="fas fa-plus mr-2"></i>Add Charge
        </button>
        <button class="btn-info" data-bs-toggle="modal" data-bs-target="#addCreditModal">
            <i class="fas fa-gift mr-2"></i>Add Credit
        </button>
    </div>
</div>

<!-- Transaction History -->
<div class="px-6 pb-6">
    <h3 class="text-xl font-bold text-gray-100 mb-4 flex items-center">
        <i class="fas fa-history mr-3"></i>Transaction History
    </h3>

    {% if transactions %}
        <div class="space-y-3">
            {% for transaction in transactions %}
                <div class="card border-t-2 {% if transaction.transaction_type == 'payment' %}border-green-500{% elif transaction.transaction_type == 'debit' %}border-red-500{% else %}border-cyan-500{% endif %}">
                    <div class="flex flex-wrap items-start justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2 mb-1">
                                {% if transaction.transaction_type == 'payment' %}
                                    <i class="fas fa-arrow-down text-green-400"></i>
                                    <span class="font-semibold text-gray-100">Payment Received</span>
                                {% elif transaction.transaction_type == 'debit' %}
                                    <i class="fas fa-arrow-up text-red-400"></i>
                                    <span class="font-semibold text-gray-100">Charge Added</span>
                                {% else %}
                                    <i class="fas fa-gift text-cyan-400"></i>
                                    <span class="font-semibold text-gray-100">Credit Applied</span>
                                {% endif %}
                            </div>
                            <div class="text-sm text-gray-400">
                                {{ transaction.transaction_date.strftime('%m/%d/%Y') if transaction.transaction_date else 'N/A' }}
                            </div>
                            {% if transaction.description %}
                                <div class="text-sm text-gray-400 mt-2 pt-2 border-t border-gray-700">
                                    {{ transaction.description }}
                                    {% if transaction.order_id %}
                                        <a href="{{ url_for('orders') }}?order_id={{ transaction.order_id }}" class="text-secondary hover:text-secondary-light transition-colors">
                                            (Order #{{ transaction.order_id }})
                                        </a>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="flex items-center space-x-3">
                            <div class="text-xl font-bold {% if transaction.transaction_type == 'payment' %}text-green-400{% elif transaction.transaction_type == 'debit' %}text-red-400{% else %}text-cyan-400{% endif %}">
                                {% if transaction.transaction_type == 'payment' %}
                                    -¥{{ "{:,.0f}".format(transaction.amount) }}
                                {% else %}
                                    +¥{{ "{:,.0f}".format(transaction.amount) }}
                                {% endif %}
                            </div>

                            <button class="btn-action btn-danger"
                                    data-id="{{ transaction.account_id }}"
                                    data-description="{{ transaction.description }}"
                                    data-amount="{{ transaction.amount }}"
                                    title="Delete transaction">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <i class="fas fa-receipt text-6xl mb-4 text-gray-600"></i>
            <h4 class="text-xl font-semibold text-gray-300 mb-2">No Transactions Yet</h4>
            <p class="text-gray-400">Start by adding a payment or charge for this customer</p>
        </div>
    {% endif %}
</div>

<!-- Add Payment Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-credit-card mr-2"></i>Add Payment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="paymentForm">
                <div class="modal-body">
                    <input type="hidden" name="transaction_type" value="payment">
                    <div class="form-group">
                        <label class="form-label">Payment Amount (¥) *</label>
                        <input type="number" class="form-input" name="amount" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Date *</label>
                        <input type="date" class="form-input" name="transaction_date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" name="description" rows="2" placeholder="Payment details..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn-success">Add Payment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Debit Modal -->
<div class="modal fade" id="addDebitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus mr-2"></i>Add Charge
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="debitForm">
                <div class="modal-body">
                    <input type="hidden" name="transaction_type" value="debit">
                    <div class="form-group">
                        <label class="form-label">Charge Amount (¥) *</label>
                        <input type="number" class="form-input" name="amount" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Charge Date *</label>
                        <input type="date" class="form-input" name="transaction_date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description *</label>
                        <textarea class="form-input" name="description" rows="2" placeholder="Reason for charge..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn-danger">Add Charge</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Credit Modal -->
<div class="modal fade" id="addCreditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-gift mr-2"></i>Add Credit
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="creditForm">
                <div class="modal-body">
                    <input type="hidden" name="transaction_type" value="credit">
                    <div class="form-group">
                        <label class="form-label">Credit Amount (¥) *</label>
                        <input type="number" class="form-input" name="amount" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Credit Date *</label>
                        <input type="date" class="form-input" name="transaction_date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description *</label>
                        <textarea class="form-input" name="description" rows="2" placeholder="Reason for credit..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn-info">Add Credit</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Transaction Modal -->
<div class="modal fade" id="deleteTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header-danger">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Delete Transaction
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>Warning!</strong> This action cannot be undone.
                </div>
                <p class="text-gray-300">Are you sure you want to delete this transaction?</p>
                <div id="deleteTransactionDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-danger" id="confirmDeleteTransaction">Delete Transaction</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const customerName = '{{ customer.customer_name }}';

    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    document.querySelectorAll('input[name="transaction_date"]').forEach(input => {
        if (!input.value) {
            input.value = today;
        }
    });

    // Handle form submissions
    ['paymentForm', 'debitForm', 'creditForm'].forEach(formId => {
        const form = document.getElementById(formId);
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                fetch(`/customer-account/${encodeURIComponent(customerName)}/add-transaction`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while processing the transaction');
                });
            });
        }
    });

    // Handle delete transaction
    let deleteTransactionId = null;

    document.querySelectorAll('.btn-action.btn-danger').forEach(btn => {
        btn.addEventListener('click', function() {
            deleteTransactionId = this.dataset.id;
            const description = this.dataset.description;
            const amount = this.dataset.amount;

            document.getElementById('deleteTransactionDetails').innerHTML = `
                <div class="alert alert-info">
                    <strong>Amount:</strong> ¥${parseFloat(amount).toLocaleString()}<br>
                    <strong>Description:</strong> ${description || 'No description'}
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('deleteTransactionModal'));
            modal.show();
        });
    });

    document.getElementById('confirmDeleteTransaction').addEventListener('click', function() {
        if (deleteTransactionId) {
            fetch(`/customer-account/${encodeURIComponent(customerName)}/delete-transaction/${deleteTransactionId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the transaction');
            });
        }
    });

    // Auto-dismiss alerts
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            if (alert && !alert.classList.contains('alert-warning')) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        });
    }, 5000);
});
</script>
{% endblock %}
