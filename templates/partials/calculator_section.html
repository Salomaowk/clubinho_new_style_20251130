<!-- Calculator Section -->
<div class="calculator-container">
    <div class="calculator-header">
        <h3><i class="fas fa-calculator me-2"></i>Book Import Calculator</h3>
        <p>Brazil → Japan Import Quotes</p>
    </div>
    
    <!-- Messages Container -->
    <div id="messages-container"></div>
    
    <form class="calculator-form" id="calculatorForm" novalidate>
        <!-- Customer Name -->
        <div class="form-group">
            <label class="form-label" for="customer-name">
                <i class="fas fa-user me-2"></i>Customer Name
            </label>
            <div class="combobox-container">
                <input type="text" 
                       id="customer-name" 
                       name="customer-name"
                       class="form-control combobox-input" 
                       placeholder="Type customer name..." 
                       maxlength="50"
                       autocomplete="off">
            </div>
            <small class="currency-note">Maximum 50 characters</small>
        </div>

        <!-- Book Title -->
        <div class="form-group">
            <label class="form-label" for="book-title">
                <i class="fas fa-book me-2"></i>Book Title
            </label>
            <div class="combobox-container">
                <input type="text" 
                       id="book-title" 
                       name="book-title"
                       class="form-control combobox-input" 
                       placeholder="Type book title..." 
                       maxlength="100"
                       autocomplete="off">
            </div>
            <small class="currency-note">Maximum 100 characters</small>
        </div>

        <!-- Book Price -->
        <div class="form-group">
            <label class="form-label" for="book-price">
                <i class="fas fa-dollar-sign me-2"></i>Book Price <span class="text-danger">*</span>
            </label>
            <input type="number" 
                   id="book-price" 
                   name="book-price"
                   class="form-control" 
                   placeholder="e.g., 25.90" 
                   step="0.01" 
                   min="0" 
                   required>
            <small class="currency-note">Brazilian Real (R$)</small>
        </div>

        <!-- Profit Percentage -->
        <div class="form-group">
            <div class="label-with-button">
                <label class="form-label profit-label">
                    <i class="fas fa-chart-line me-2"></i>Profit (30%) <span class="text-danger">*</span>
                </label>
                <button type="button" class="btn-edit-profit" title="Edit profit percentage">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
            <input type="text" 
                   class="form-control" 
                   value="Will be calculated automatically" 
                   readonly
                   tabindex="-1">
            <div class="custom-input" style="display: none;">
                <input type="number" 
                       id="custom-profit" 
                       name="custom-profit"
                       class="form-control" 
                       placeholder="Enter custom profit percentage"
                       min="0" 
                       max="100" 
                       step="0.1">
            </div>
            <small class="currency-note">Brazilian Real (R$)</small>
        </div>

        <!-- Shipping Cost -->
        <div class="form-group">
            <label class="form-label" for="shipping-cost">
                <i class="fas fa-shipping-fast me-2"></i>Shipping Cost <span class="text-danger">*</span>
            </label>
            <select id="shipping-cost" name="shipping-cost" class="form-control" required>
                <option value="">Select shipping cost</option>
                <!-- Options will be populated by JavaScript -->
            </select>
            <input type="number" 
                   id="shipping-custom" 
                   name="shipping-custom"
                   class="form-control" 
                   placeholder="Enter custom shipping cost"
                   min="0" 
                   step="0.01"
                   style="display: none; margin-top: 10px;">
            <small class="currency-note">Brazilian Real (R$)</small>
        </div>

        <!-- Shipping Adjustment -->
        <div class="form-group">
            <label class="form-label" for="shipping-adjustment">
                <i class="fas fa-cog me-2"></i>Shipping Adjustment
            </label>
            <input type="number" 
                   id="shipping-adjustment" 
                   name="shipping-adjustment"
                   class="form-control" 
                   placeholder="e.g., 200" 
                   step="1">
            <small class="currency-note">Additional amount in Japanese Yen (¥) - optional</small>
        </div>

        <!-- Action Buttons -->
        <div class="button-container">
            <button type="submit" class="btn-calculate" id="calculate-btn">
                <i class="fas fa-calculator me-2"></i>Calculate Quote
            </button>
            <button type="button" class="btn-clear" id="clear-btn">
                <i class="fas fa-trash me-2"></i>Clear
            </button>
        </div>

        <!-- Results Section -->
        <div class="results" id="results" style="display: none;">
            <!-- Results will be dynamically populated by JavaScript -->
        </div>
    </form>
</div>

<style>
/* Additional CSS for the fixed functionality */
.combobox-container {
    position: relative;
}

.combobox-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.combobox-option {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
}

.combobox-option:hover {
    background-color: #f8f9fa;
}

.combobox-option:last-child {
    border-bottom: none;
}

.combobox-option.add-new {
    background-color: #e8f4f8;
    color: #0066cc;
    font-weight: 600;
}

.combobox-option.add-new:hover {
    background-color: #d1ecf1;
}

.custom-input {
    margin-top: 10px;
}

.btn-edit-profit {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #007bff;
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.btn-edit-profit:hover {
    background: #0056b3;
    transform: scale(1.1);
}

.label-with-button {
    display: flex;
    align-items: center;
    gap: 10px;
}

.currency-note {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
    display: block;
}

.results {
    margin-top: 20px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.result-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #dee2e6;
}

.result-item:last-child {
    border-bottom: none;
}

.result-label {
    font-weight: 600;
    color: #495057;
}

.result-value {
    font-weight: 700;
    color: #212529;
}

.copy-container {
    display: flex;
    align-items: center;
    gap: 10px;
}

.btn-copy, .btn-approve {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 5px;
}

.btn-copy {
    background: #28a745;
    color: white;
}

.btn-copy:hover {
    background: #218838;
}

.btn-copy.copied {
    background: #6c757d;
}

.btn-approve {
    background: #17a2b8;
    color: white;
}

.btn-approve:hover {
    background: #138496;
}

.exchange-info {
    text-align: center;
    font-size: 12px;
    color: #6c757d;
    margin-top: 15px;
    font-style: italic;
}

.button-container {
    display: flex;
    gap: 15px;
    margin-bottom: 0;
}

.btn-calculate {
    flex: 2;
    background: #007bff;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-calculate:hover:not(:disabled) {
    background: #0056b3;
}

.btn-calculate:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-clear {
    flex: 1;
    background: #6c757d;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-clear:hover {
    background: #545b62;
}

.alert {
    padding: 12px 16px;
    margin-bottom: 15px;
    border: 1px solid transparent;
    border-radius: 6px;
    font-size: 14px;
}

.alert-success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
}

.alert-danger {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
}

.btn-close {
    float: right;
    background: none;
    border: none;
    font-size: 16px;
    cursor: pointer;
    color: inherit;
}
</style>

<script>
// Function to switch tabs (called from template)
function switchToCalculator() {
    const calculatorTab = document.getElementById('calculator-tab');
    if (calculatorTab) {
        calculatorTab.click();
        // Ensure calculator is initialized when tab is switched
        setTimeout(() => {
            if (window.ensureCalculatorInitialized) {
                window.ensureCalculatorInitialized();
            }
        }, 100);
    }
}

function switchToOrders() {
    const ordersTab = document.getElementById('orders-tab');
    if (ordersTab) {
        ordersTab.click();
    }
}

function switchToQuotes() {
    const quotesTab = document.getElementById('quotes-tab');
    if (quotesTab) {
        quotesTab.click();
    }
}

// Initialize calculator when this section becomes visible
document.addEventListener('DOMContentLoaded', function() {
    // Observer to detect when calculator tab becomes active
    const calculatorContent = document.getElementById('calculator-content');
    if (calculatorContent) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (calculatorContent.classList.contains('active') && calculatorContent.classList.contains('show')) {
                        setTimeout(() => {
                            if (window.ensureCalculatorInitialized) {
                                window.ensureCalculatorInitialized();
                            }
                        }, 100);
                    }
                }
            });
        });
        
        observer.observe(calculatorContent, {
            attributes: true,
            attributeFilter: ['class']
        });
    }
});
</script>